#!/usr/bin/env perl

use strict;
use utf8;
use Encode;
use FindBin qw/$Bin/;
use lib "$Bin/../perllib/";
use FileHandle;
use File::Temp 'tempdir';
use IO::File;

binmode STDIN, ":encoding(utf8)";
binmode STDOUT, ":encoding(utf8)";
binmode STDERR, ":encoding(utf8)";

STDOUT->autoflush(1);

#
# This splitter should be used only when lang_source="ja".
#
# There are 2 steps.
# The first step, we use the default splitter that work with either Japanese, Chinese, or English.
# The second step, we send each sentence from step 1 to a specialized Japanese splitter
# that will split long sentences having the GA particle in the middle.
#

my $response = '';

my $lang_source = $ARGV[0];
my $lang_target = $ARGV[1];

my $src = '';
while (<STDIN>) {
    $_ =~ s/^\s*(.*?)\s*$/$1/; # 両端のスペース消去
    $src .= "$_\n";
}

die "no input!" if ($src eq "");

my $tmpdir = tempdir;

# 文に分割
my $temp_file = "$tmpdir/in";
open(my $fh_out, ">:encoding(utf8)", $temp_file) or die "$temp_file: $!";
my @lines = split(/\n/, $src);
foreach my $line (@lines){
    if ($line ne ""){
        print $fh_out "$lang_source: $line\n" or die "writing $temp_file: $!";
    }
}
close($fh_out);

my @sentences = `perl -I perllib $Bin/sentence-splitter_ecj-utf8.perl < $temp_file`;
foreach my $s (@sentences){
    $s = decode('utf8', $s);
    chomp $s;
    $s =~ s/^$lang_source: //;
}

my $temp_file2 = "$tmpdir/in2";
open(my $fh_out2, ">:encoding(utf8)", $temp_file2) or die "$temp_file2: $!";
foreach my $sentence (@sentences) {
    print $fh_out2 "$sentence\n" or die "writing $temp_file2: $!";
}
close($fh_out2);

my @sentences2 = `$Bin/long-sentence-splitter $temp_file2`;
foreach my $s (@sentences2){
    $s = decode('utf8', $s);
    chomp $s;
}

# 文分割が失敗した場合
if (scalar(@sentences2) == 0) {
    @sentences2 = @lines;
}

foreach my $sentence (@sentences2) {
    print "$sentence\n";
}
