#!/usr/bin/env zsh

display_usage() {
    echo "This script must be run in a proper python environment."
    echo "\nUsage:\nbin/$0 config [gpu]"
    echo "\nExample:\nbin/$0 server-je.conf 0\n"
}

if [ $# -lt 1 ]
then
    display_usage
    exit 1
fi

CONFIG="$1"
RNN_SEARCH_GPU="$2"

typeset -A PARSE_SERVER_LANG

PARSE_SERVER_LANG['ce']='zh'
PARSE_SERVER_LANG['cj']='zh'
PARSE_SERVER_LANG['ec']='en'
PARSE_SERVER_LANG['ej']='en'
PARSE_SERVER_LANG['jc']='ja'
PARSE_SERVER_LANG['je']='ja'

source "$CONFIG"

OPT_GPU=""
if [[ ! -z "$RNN_SEARCH_GPU" ]]; then
    OPT_GPU="--gpu $RNN_SEARCH_GPU"
fi

OPT_DIC=""
if [[ ! -z "$RNN_SEARCH_DICTIONARY" ]]; then
    OPT_DIC="--dic $RNN_SEARCH_DICTIONARY"
fi

server_cmd="python nmt_chainer/server.py  --port $PORT --parse_server_command=\"$PARSE_SERVER_COMMAND\" $OPT_DIC \
    $RNN_SEARCH_CONFIG $RNN_SEARCH_MODEL $OPT_GPU"
echo "$server_cmd"
eval "$server_cmd"
